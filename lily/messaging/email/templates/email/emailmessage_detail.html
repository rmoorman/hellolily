{% extends 'email/emailmessage_base.html' %}

{% load i18n email %}

{% block inbox %}
<div class="col-md-10 emailmessage-detail">
    <div class="inbox-header">
        <h1 class="pull-left">{{ folder_name }} {% if active_email_address %}<small>{% trans 'in' %} {{ active_email_account.email }}</small>{% endif %}</h1>
    </div>
    <div class="inbox-content">
        <div class="inbox-header inbox-view-header">
            <h1 class="pull-left">{{ object.subject }} <a href="{% url 'messaging_email_account_folder' account_id=active_email_account.id folder=object.folder_name|urlencode %}">{{ object.folder_name }}</a></h1>
            {% comment %}
            <div class="pull-right"><i class="icon-print"></i></div>
            {% endcomment %}
        </div>
        <div class="inbox-view-info">
            <div class="row">
                <div class="email-info-top">
                    <span class="bold">{{ object.from_name }}</span> <span>&lt;{{ object.from_email }}&gt;</span>
                    <div class="pull-right">
                        <span class="bold"><abbr title="{{ object.sent_date|pretty_datetime:'%d %B %Y %H:%M' }}">{{ object.sent_date|pretty_datetime_relative:'%d %b.' }}</abbr></span>
                        <div class="inbox-info-btn">
                            <div class="btn-group">
                                <button class="btn blue reply-btn" data-href="{% url 'messaging_email_reply' pk=object.id %}" data-loading-text="<i class='icon-spinner icon-spin'></i> {% trans 'Loading' %}">
                                    <i class="icon-reply"></i> {% trans 'Reply' %}
                                </button>
                                <button class="btn blue dropdown-toggle" data-toggle="dropdown" data-hover="dropdown">
                                    <i class="icon-angle-down"></i>
                                </button>
                                <ul class="dropdown-menu pull-right">
                                    <li>
                                        <a href="{% url 'messaging_email_reply' pk=object.id %}"><i class="icon-reply"></i> {% trans 'Reply' %}</a>
                                    </li>
                                    {% comment %}
                                    <li>
                                        <a href="#"><i class="icon-reply-all"></i> {% trans 'Reply All' %}</a>
                                    </li>
                                    {% endcomment %}
                                    <li>
                                        <a href="{% url 'messaging_email_forward' pk=object.id %}"><i class="icon-arrow-right"></i> {% trans 'Forward' %}</a>
                                    </li>
                                    {% comment %}
                                    <li>
                                        <a href="#"><i class="icon-print"></i> {% trans 'Print' %}</a>
                                    </li>
                                    {% endcomment %}
                                    <li>
                                        <form action="{% url 'messaging_mark_unread' %}" method="post" id="mark-unread-form-{{ object.id }}">
                                            {% csrf_token %}
                                            <input type="hidden" name="ids[]" value="{{ object.id }}">
                                            <input type="hidden" name="next" value="{% url 'messaging_email_account_folder' account_id=active_email_account.id folder=object.folder_name|urlencode %}">
                                        </form>
                                        <a href="{% url 'messaging_mark_unread' %}" data-form-submit data-form-selector="#mark-unread-form-{{ object.id }}"><i class="icon-fixed-width"></i> {% trans 'Mark as unread' %}</a>
                                    </li>
                                </ul>
                                {% if all_mail_folder %}
                                    <form class="hidden" action="{% url 'move_messages_view' %}" method="post" id="archive-form-{{ object.id }}">
                                        {% csrf_token %}
                                        <input type="hidden" name="ids[]" value="{{ object.id }}">
                                        <input type="hidden" name="folder" value="{{ all_mail_folder }}">
                                        <input type="hidden" name="next" value="{% url 'messaging_email_account_folder' account_id=active_email_account.id folder=object.folder_name|urlencode %}">
                                    </form>
                                    <button class="btn blue email-detail-extra-btn" data-form-submit data-form-selector="#archive-form-{{ object.id }}" data-loading-text="<i class='icon-spinner icon-spin'></i> {% trans 'Archiving' %}"><i class="icon-archive"></i> {% trans 'Archive' %}</button>
                                {% endif %}
                                <form class="hidden" action="{% url 'messaging_move_trash' %}" method="post" id="delete-form-{{ object.id }}">
                                    {% csrf_token %}
                                    <input type="hidden" name="ids[]" value="{{ object.id }}">
                                    <input type="hidden" name="next" value="{% url 'messaging_email_account_folder' account_id=active_email_account.id folder=object.folder_name|urlencode %}">
                                </form>
                                <button class="btn blue email-detail-extra-btn" data-form-submit data-form-selector="#delete-form-{{ object.id }}" data-loading-text="<i class='icon-spinner icon-spin'></i> {% trans 'Deleting' %}"><i class="icon-trash"></i> {% trans 'Delete' %}</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="email-recipients-wrapper">
                    {% if object.to_emails|length > 0 %}
                        <div class="email-recipients overlay">
                            <span>{% trans 'To' %}:</span>
                            {% for name, email in object.to_emails %}
                                <span title="{{ email }}">{% if name %}{{ name }}{% else %}{{ email }}{% endif %}</span>{% if forloop.counter != object.to_emails|length %}, {% endif %}
                            {% endfor %}
                        </div>
                        <button class="btn show-more-recipients hide"><i class="icon-collapse"></i></button>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="inbox-loading">
            <i class="icon-spinner icon-spin"></i> {% trans 'Loading..' %}
        </div>
        <div class="inbox-view">
            {% comment %}
            <iframe src="{% url 'messaging_email_html' object.pk %}" class="col-xs-12 col-md-12" data-scroller="true" data-always-visible="1" data-rail-visible="1" scrolling="no"></iframe>
            {% endcomment %}
            <iframe src="{% url 'messaging_email_html' object.pk %}" class="col-xs-12 col-md-12" data-message-id="{{ object.pk }}"></iframe>
        </div>
        {% if object.attachments.count > 0 %}
        <hr>
        <div class="inbox-attached">
            <div class="margin-bottom-15">
                <span>{% blocktrans count object.attachments.count as counter %}{{ counter }} attachment{% plural %}{{ counter }} attachments{% endblocktrans %}</span>
            </div>
            {% for attachment in object.attachments.all %}
            <div class="margin-bottom-25">
                <div>
                    <strong>{{ attachment }}</strong>
                    <span>{{ attachment.size|filesizeformat }}</span>
                    <a href="{% url 'email_attachment_proxy_view' pk=attachment.pk %}">{% trans 'Download' %}</a>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
{% block scripts %}
{{ block.super }}
<script>
$(function($) {
    var show_all_recipients = false;

    $('.btn-group-spaced [data-form-submit], .reply-btn, .inbox-info-btn .dropdown-menu a').click(function() {
        // Waiting for response from server so a redirect will 'unblock' the UI
        if($(this).hasClass('email-detail-extra-btn')) {
            // Set loading text on archive button when it's clicked
            $(this).button('loading');
        }
        else {
            // Otherwise one of the other buttons is clicked, so set loading text on the reply button
            $('.reply-btn').button('loading');
        }
        App.blockUI($('.inbox-content'), false, '');
    });

    $('.show-more-recipients').click(function() {
        var icon = $(this).find('i');
        var options = {
            complete: toggle_overlay
        };

        if (show_all_recipients) {
            icon.toggleClass('icon-collapse icon-collapse-top');
            $('.email-recipients').animate({height: '18px'}, options);
        }
        else {
            icon.toggleClass('icon-collapse-top icon-collapse');
            // height: 100% doesn't show an animation, so using scrollHeight
            $('.email-recipients').animate({height: $('.email-recipients')[0].scrollHeight}, options);
            // instantly remove overlay so it isn't shown while animation is playing
            $('.email-recipients').removeClass('overlay');
        }
    });

    function toggle_overlay() {
        if (show_all_recipients) {
            $('.email-recipients').addClass('overlay');
            show_all_recipients = false;
        }
        else {
            show_all_recipients = true;
        }
    }

    $(document).on('taskmonitor_get_from_imap', function(event) {
        var task_result = event.task_result;
        if (task_result) {
            var iframe = $('.inbox-view').find('iframe[data-message-id="' + task_result.message_id + '"]').get(0);
            // Reload the iframe and get the message
            iframe.src = iframe.src;
        }
    });

    // if the list of recipients is 2 or more lines, display the button
    if($('.email-recipients').length && $('.email-recipients')[0].scrollHeight != $('.email-recipients').height()) {
        $('.show-more-recipients').removeClass('hide');
    }
});
</script>
{% endblock %}
