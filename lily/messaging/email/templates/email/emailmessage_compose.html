{% extends 'email/emailmessage_base.html' %}

{% load compressed i18n email bootstrap3 %}

{% block css %}
    {{ block.super }}
    {% compressed_css 'wysihtml5' %}
{% endblock %}

{% block inbox %}
<div class="col-md-10 emailmessage-detail">
    <div class="inbox-header">
        <h1 class="pull-left">{% trans 'Compose' %}</h1>
    </div>
    <div class="inbox-content">
        {{ form.non_field_errors }}

        <form class="inbox-compose form-horizontal" id="fileupload" method="POST" enctype="multipart/form-data" novalidate>
            {% csrf_token %}

            <div class="inbox-compose-btn">
                <button type="submit" name="submit-send" class="btn green" data-loading-text="<i class='icon-spinner icon-spin'></i> {% trans 'Sending..' %}"><i class="icon-ok"></i>{% trans 'Send' %}</button>
                <button type="submit" name="submit-discard" class="btn blue" data-loading-text="<i class='icon-spinner icon-spin'></i> {% trans 'Discarding..' %}">{% trans 'Discard' %}</button>
                <button type="submit" name="submit-save" class="btn blue" data-loading-text="<i class='icon-spinner icon-spin'></i> {% trans 'Saving..' %}">{% trans 'Draft' %}</button>
            </div>
            <div class="inbox-form-group mail-from">
                <label class="control-label">{% trans 'From' %}:</label>
                <div class="controls controls-from">
                    {% bootstrap_field form.send_from layout="horizontal" show_label=False field_class="col-md-12" form_group_class="" %}
                </div>
            </div>
            <div class="inbox-form-group mail-to {% if form.errors.send_to_normal %}has-error{% endif %}">
                <label class="control-label">{% trans 'To' %}:</label>
                <div class="controls controls-to">
                    {% bootstrap_field form.send_to_normal layout="horizontal" show_label=False field_class="col-md-12" form_group_class="" %}
                    <span class="inbox-cc-bcc">
                        <span class="inbox-cc">{% trans 'Cc' %}</span>
                        <span class="inbox-bcc">{% trans 'Bcc' %}</span>
                    </span>
                </div>
                <div class="inbox-form-group input-cc display-hide">
                    <a href="javascript:void(0)" class="close"></a>
                    <label class="control-label">{% trans 'Cc' %}:</label>
                    <div class="controls controls-cc">
                        {% bootstrap_field form.send_to_cc layout="horizontal" show_label=False field_class="col-md-12" form_group_class="" %}
                    </div>
                </div>
                <div class="inbox-form-group input-bcc display-hide">
                    <a href="javascript:void(0)" class="close"></a>
                    <label class="control-label">{% trans 'Bcc' %}:</label>
                    <div class="controls controls-bcc">
                        {% bootstrap_field form.send_to_bcc layout="horizontal" show_label=False field_class="col-md-12" form_group_class="" %}
                    </div>
                </div>
            </div>
            <div class="inbox-form-group">
                <label class="control-label">{% trans 'Subject' %}:</label>
                <div class="controls">
                    {% bootstrap_field form.subject layout="horizontal" show_label=False field_class="col-md-12" form_group_class="" %}
                </div>
            </div>
            {% if template_list %}
            <div class="inbox-form-group">
                <label class="control-label">{% trans 'Template' %}:</label>
                <div class="controls">
                    {% bootstrap_field form.template layout="horizontal" show_label=False field_class="col-md-12" form_group_class="" %}
                </div>
            </div>
            {% endif %}
            <div class="inbox-form-group margin-bottom-10">
                {% include 'wysihtml5_toolbar.html' %}
                {% bootstrap_field form.body_html layout="horizontal" show_label=False field_class=" " form_group_class="" %}
            </div>
            {{ form.attachments }}
            <div class="inbox-compose-btn">
                <button type="submit" name="submit-send" class="btn green" data-loading-text="<i class='icon-spinner icon-spin'></i> {% trans 'Sending..' %}"><i class="icon-ok"></i>{% trans 'Send' %}</button>
                <button type="submit" name="submit-discard" class="btn blue" data-loading-text="<i class='icon-spinner icon-spin'></i> {% trans 'Discarding..' %}">{% trans 'Discard' %}</button>
                <button type="submit" name="submit-save" class="btn blue" data-loading-text="<i class='icon-spinner icon-spin'></i> {% trans 'Saving..' %}">{% trans 'Draft' %}</button>
            </div>
        </form>
    </div>
</div>
<div class="modal fade" id="modal_no_email_address" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                <h4 class="modal-title">{% trans "I'm sorry" %}</h4>
            </div>
            <div class="modal-body">
                {% trans "I couldn't find a recipient, could you please fill in where I need to send this mail." %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn default" data-dismiss="modal">{% trans 'Ok' %}</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
    {{ block.super }}
    {% compressed_js 'wysihtml5' %}
<script>
{% if template_list %}
var templateList = {{ template_list|safe }};
        var confirmation_text = '{% trans 'This will cause you to lose all data already entered within the email body and subject. Click "OK" to continue or "Cancel" to prevent this.' %}';
{% endif %}
$(function($) {
    Inbox.init();
    $('.inbox-compose [type="submit"]').click(function (event) {
        if($(this).attr('name') == 'submit-save') {
            event.preventDefault();

            App.blockUI($('.inbox-content'), false, '');
            $(this).button('loading');

            toastr.info('{% trans 'Attempting to save email as a draft' %}');

            var form = $(this).closest('form');

            // Add button name which is used for certain checks
            $('<input />').attr('type', 'hidden')
            .attr('name', $(this).attr('name'))
            .attr('value', '')
            .appendTo(form);

            var jqXHR = $.ajax({
                type: 'POST',
                dataType: 'json',
                data: $(form).serialize(),
                beforeSend: addCSRFHeader
            });
            jqXHR.done(function (response) {
                get_task_response(response.task_id);
                // remove request object
                jqXHR = null;
            });
        }
    });

    $(document).on('taskmonitor_save_message', function (event) {
        if(event.task_result) {
            toastr.success('{% trans 'Your message has been saved as a draft!' %}', '{% trans 'Success!' %}');

            var url = '{% url 'messaging_email_compose' pk='000' %}';
            redirect_to(url.replace('000', event.task_result));
        }
        else {
            toastr.error('{% trans 'There was an error while creating the draft, please try again!' %}', '{% trans 'Oops!' %}');
        }
    });
});
</script>
{% endblock %}
